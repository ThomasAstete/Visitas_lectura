---
// components/LoginForm.astro
---

<form id="loginForm" class="flex flex-col gap-4">
  <input 
    type="text" 
    name="username" 
    placeholder="Usuario" 
    class="border p-2 rounded" 
    required 
  />
  <input 
    type="password" 
    name="password" 
    placeholder="Contraseña" 
    class="border p-2 rounded" 
    required 
  />
  <button 
    type="submit" 
    class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition-colors"
  >
    Entrar
  </button>
</form>

<script type="module">
  // Asegurarse de que Cookies esté disponible
  const Cookies = window.Cookies;

  export function setupLoginForm() {
    const form = document.getElementById('loginForm');
    const errorMsg = document.getElementById('error');

    if (!form) {
      console.error('No se encontró el formulario de login');
      return;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (errorMsg) errorMsg.classList.add('hidden');

      const data = new FormData(form);
      const username = data.get('username');
      const password = data.get('password');

      try {
        // Importar la función login
        const { login } = await import('../lib/api.js');
        const res = await login(username, password);

        // Guardar token
        if (res.access) {
          Cookies.set('access_token', res.access, { expires: 1 });
          if (res.refresh) Cookies.set('refresh_token', res.refresh, { expires: 7 });
          Cookies.set('auth_scheme', 'Bearer');
        } else if (res.token) {
          Cookies.set('access_token', res.token, { expires: 7 });
          Cookies.set('auth_scheme', 'Token');
        } else {
          throw new Error('No se obtuvo token del servidor');
        }

        window.location.href = '/dashboard';
      } catch (err) {
        console.error(err);
        if (errorMsg) {
          errorMsg.textContent = 'Usuario o contraseña incorrectos';
          errorMsg.classList.remove('hidden');
        }
      }
    });
  }

  // Ejecutar cuando el componente se cargue
  setupLoginForm();
</script>