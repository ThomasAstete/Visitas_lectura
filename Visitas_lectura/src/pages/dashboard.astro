---
// pages/dashboard.astro - CORREGIDO
import ChartSelector from '../components/ChartSelector.astro';
import VisitasChart from '../components/VisitasChart.astro';
import "../styles/global.css";
---

<html lang="es">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Visitas</title>
  </head>
  <body class="min-h-screen bg-gray-100 p-6">
    <div class="max-w-6xl mx-auto">
      <header class="flex items-center justify-between mb-6 bg-white p-4 rounded shadow">
        <h1 class="text-2xl font-bold">Dashboard - Visitas</h1>
        <button 
          id="logoutBtn" 
          class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors"
        >
          Cerrar sesión
        </button>
      </header>

      <section class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-4">Lista de Visitas</h2>
        <div id="status" class="text-gray-600 mb-4">Cargando datos...</div>
        
        <!-- Lista de visitas -->
        <ul id="visitasList" class="space-y-3 mb-6"></ul>
        
        <!-- Selector de gráficos -->
        <ChartSelector />
        
        <!-- Gráfico -->
        <VisitasChart />
      </section>
    </div>

    <script type="module">
      import Cookies from 'js-cookie';
      import { getVisitas, logout } from '../lib/api.js';

      // Exponer Cookies globalmente para otras librerías/componentes que lo esperan
      window.Cookies = Cookies;

      // Redirección si no hay token
      if (!Cookies.get('access_token')) window.location.href = '/login';

      const status = document.getElementById('status');
      const visitasList = document.getElementById('visitasList') || document.getElementById('list');
      const logoutBtn = document.getElementById('logoutBtn');
      const canvas = document.getElementById('visitasChart');

      logoutBtn && logoutBtn.addEventListener('click', () => logout());

      function groupByDate(items) {
        const counts = {};
        for (const it of items) {
          let d = it.hora_entrada || null;
          if (d) d = d.split('T')[0];
          else d = 'sin_fecha';
          counts[d] = (counts[d] || 0) + 1;
        }
        return counts;
      }

      function renderVisitasList(items) {
        if (!visitasList) return;
        if (!items || !items.length) {
          visitasList.innerHTML = '<li class="text-gray-500 text-center py-4">No hay visitas registradas.</li>';
          return;
        }

        visitasList.innerHTML = items.map(v => `
          <li class="p-4 border rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-medium">${v.nombre || 'Visitante'}</div>
                <div class="text-sm text-gray-500">Entrada: ${v.hora_entrada || '—'} | Salida: ${v.hora_salida || '—'}</div>
              </div>
            </div>
          </li>
        `).join('');
      }

      async function loadVisitas() {
        try {
          const resp = await getVisitas();
          const items = resp.data || resp || [];

          if (!items.length) {
            if (status) status.textContent = 'No hay visitas registradas.';
            renderVisitasList(items);
            return;
          }

          if (status) status.textContent = `Total de visitas: ${items.length}`;
          renderVisitasList(items);

          // Si el componente VisitasChart ya registró createChart, úsalo
          if (window.createChart) {
            window.createChart(items, 'bar');
            return;
          }

          // Fallback: crear gráfico directamente importando Chart.js desde la dependencia
          if (canvas) {
            const ChartModule = await import('chart.js/auto');
            const Chart = ChartModule && (ChartModule.default || ChartModule.Chart || ChartModule);

            const counts = groupByDate(items);
            const labels = Object.keys(counts).sort();
            const data = labels.map(l => counts[l]);

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels,
                datasets: [{
                  label: 'Visitas',
                  data,
                  backgroundColor: 'rgba(54,162,235,0.6)',
                  borderColor: 'rgba(54,162,235,1)',
                  borderWidth: 1,
                }],
              },
              options: {
                responsive: true,
                scales: {
                  x: { title: { display: true, text: 'Fecha' } },
                  y: { beginAtZero: true, title: { display: true, text: 'Cantidad' } },
                },
              },
            });
          }

        } catch (err) {
          console.error(err);
          if (status) status.textContent = 'Error al obtener datos desde la API.';
        }
      }

      loadVisitas();
    </script>
  </body>
</html>