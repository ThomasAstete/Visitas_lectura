---
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Visitas</title>
    <link rel="stylesheet" href="/src/styles/global.css" />
  </head>
  <body class="min-h-screen bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">Dashboard - Visitas</h1>
        <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded">Cerrar sesión</button>
      </header>

      <section class="bg-white p-6 rounded shadow">
        <h2 class="text-lg font-semibold mb-4">Datos de la API</h2>
        <div id="status" class="text-gray-600 mb-4">Cargando datos...</div>
        <ul id="list" class="space-y-2"></ul>

        <div class="mt-6">
          <h3 class="font-medium mb-2">Gráfico: Visitas por fecha</h3>
          <canvas id="visitasChart" width="800" height="300" class="w-full"></canvas>
        </div>
      </section>
    </div>

    <script type="module">
      import { getVisitas, logout } from '../lib/api.js';

      const status = document.getElementById('status');
      const list = document.getElementById('list');
      const logoutBtn = document.getElementById('logoutBtn');
      const canvas = document.getElementById('visitasChart');

      logoutBtn.addEventListener('click', () => {
        logout();
      });

      function groupByDate(items) {
        const counts = {};
        for (const it of items) {
          let d = it.fecha || it.date || it.created_at || null;
          if (d) {
            // Normalizar a YYYY-MM-DD si viene con hora
            d = d.split('T')[0];
          } else {
            d = 'sin_fecha';
          }
          counts[d] = (counts[d] || 0) + 1;
        }
        return counts;
      }

      async function load() {
        try {
          const resp = await getVisitas();
          console.log('DEBUG getVisitas response:', resp);
          const items = resp.data || [];
          console.log('DEBUG items:', items);
          if (!items.length) {
            status.textContent = 'La API respondió correctamente pero no hay registros.';
            return;
          }
          status.textContent = '';
          list.innerHTML = items.map(v => `
            <li class="p-2 border rounded flex justify-between items-center">
              <div>
                <div class="font-medium">${v.titulo || v.nombre || 'Visita'}</div>
                <div class="text-sm text-gray-500">ID: ${v.id ?? '—'}</div>
              </div>
              <div class="text-sm text-gray-600">${v.fecha ?? ''}</div>
            </li>
          `).join('');

          // Preparar datos para el gráfico
          const counts = groupByDate(items);
          const labels = Object.keys(counts).sort();
          const data = labels.map(l => counts[l]);

          // Cargar Chart.js dinámicamente desde CDN (evita tocar dependencias)
          try {
            const module = await import('https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.esm.js');
            const { Chart, registerables } = module;
            Chart.register(...registerables);

            const ctx = canvas.getContext('2d');
            // eslint-disable-next-line no-unused-vars
            const visitasChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels,
                datasets: [
                  {
                    label: 'Visitas',
                    data,
                    backgroundColor: 'rgba(54,162,235,0.6)',
                    borderColor: 'rgba(54,162,235,1)',
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                scales: {
                  x: { title: { display: true, text: 'Fecha' } },
                  y: { beginAtZero: true, title: { display: true, text: 'Cantidad' } },
                },
              },
            });
          } catch (err) {
            console.error('Error cargando Chart.js:', err);
            const ph = document.createElement('div');
            ph.className = 'text-red-500 mt-2';
            ph.textContent = 'No se pudo cargar Chart.js. Revisa la consola.';
            canvas.parentNode.appendChild(ph);
          }

        } catch (err) {
          console.error(err);
          status.textContent = 'Error al obtener datos desde la API. Revisa la consola.';
        }
      }

      load();
    </script>
  </body>
</html>
