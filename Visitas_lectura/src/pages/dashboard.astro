<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Visitas</title>
    <link rel="stylesheet" href="/src/styles/global.css" />
  </head>
  <body class="min-h-screen bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">Dashboard - Visitas</h1>
        <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded">Cerrar sesión</button>
      </header>

      <section class="bg-white p-6 rounded shadow">
        <h2 class="text-lg font-semibold mb-4">Datos de la API</h2>
        <div id="status" class="text-gray-600 mb-4">Cargando datos...</div>
        <ul id="list" class="space-y-2"></ul>

        <div class="mt-6">
          <h3 class="font-medium mb-2">Gráfico: Visitas por fecha</h3>
          <canvas id="visitasChart" width="800" height="300" class="w-full"></canvas>
        </div>
      </section>
    </div>

    <script type="module">
      import Cookies from 'js-cookie';
      import { getVisitas, logout } from '../lib/api.js';

      // 1️⃣ Verificar token
      if (!Cookies.get('access_token')) window.location.href = '/login';

      const status = document.getElementById('status');
      const list = document.getElementById('list');
      const logoutBtn = document.getElementById('logoutBtn');
      const canvas = document.getElementById('visitasChart');

      logoutBtn.addEventListener('click', () => logout());

      // 2️⃣ Agrupar por fecha de entrada
      function groupByDate(items) {
        const counts = {};
        for (const it of items) {
          let d = it.hora_entrada || null;
          if (d) d = d.split('T')[0];
          else d = 'sin_fecha';
          counts[d] = (counts[d] || 0) + 1;
        }
        return counts;
      }

      async function load() {
        try {
          const resp = await getVisitas();
          const items = resp.data || [];
          if (!items.length) {
            status.textContent = 'No hay visitas registradas.';
            return;
          }
          status.textContent = '';

          // 3️⃣ Mostrar lista de visitas
          list.innerHTML = items.map(v => `
            <li class="p-2 border rounded flex justify-between items-center">
              <div>
                <div class="font-medium">${v.nombre}</div>
                <div class="text-sm text-gray-500">
                  Entrada: ${v.hora_entrada} | Salida: ${v.hora_salida || '—'}
                </div>
              </div>
            </li>
          `).join('');

          // 4️⃣ Preparar gráfico
          const counts = groupByDate(items);
          const labels = Object.keys(counts).sort();
          const data = labels.map(l => counts[l]);

          const module = await import('https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.esm.js');
          const { Chart, registerables } = module;
          Chart.register(...registerables);

          const ctx = canvas.getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Visitas',
                data,
                backgroundColor: 'rgba(54,162,235,0.6)',
                borderColor: 'rgba(54,162,235,1)',
                borderWidth: 1,
              }],
            },
            options: {
              responsive: true,
              scales: {
                x: { title: { display: true, text: 'Fecha' } },
                y: { beginAtZero: true, title: { display: true, text: 'Cantidad' } },
              },
            },
          });

        } catch (err) {
          console.error(err);
          status.textContent = 'Error al obtener datos desde la API.';
        }
      }

      load();
    </script>
  </body>
</html>
